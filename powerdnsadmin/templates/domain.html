{% extends "base.html" %}
{% block title %}<title id="page-title"></title>{% endblock %}

{% block dashboard_stat %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0 text-dark" id="domain-name"></h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active" id="breadcrumb-active"></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <section class="content">
        <div class="container-fluid">
            <div class="card" id="unsaved-changes-card" style="display: none; position: sticky; top: 0; z-index: 999;">
                <div class="card-header" style="background-color: yellow;">
                    <h3 class="card-title" style="color: red;">
                        Warning: Unsaved Changes
                    </h3>
                </div>
                <div class="card-body" style="font-size: 1rem; color: black; background-color: yellow;">
                </div>
            </div>

            <div class="card" id="spinner-card">
                <div class="card-header">
                    <h3 class="card-title">Loading Zone Records...</h3>
                </div>
                <div class="card-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-12">
                    <div class="card" id="card-zone" style="display: none;">
                        <div class="card-header" id="card-zone-header" style="display: none;">
                            <h3 class="card-title">Zone Editor</h3>
                            <div class="card-tools">
                                {% if current_user.role.name in ['Administrator', 'Operator'] %}
                                    <button type="button" id="button-zone-settings" title="Zone Settings"
                                            class="btn btn-primary btn-danger mt-2 mb-2">
                                        <i class="fa-solid fa-toolbox"></i>
                                        &nbsp;Zone Settings
                                    </button>
                                {% endif %}
                                {% if current_user.role.name in ['Administrator', 'Operator'] or allow_user_view_history %}
                                    <button type="button" id="button-zone-changelog" title="Changelog"
                                            class="btn btn-primary ml-2 mt-2 mb-2 button_changelog">
                                            <i class="fa-solid fa-history" aria-hidden="true"></i>
                                        &nbsp;Changelog
                                    </button>
                                {% endif %}
                                <button type="button" id="button-add-record" title="Add Record"
                                        class="btn btn-primary ml-2 mt-2 mb-2 button_add_record" style="display: none;">
                                    <i class="fa-solid fa-plus"></i>
                                    &nbsp;Add Record
                                </button>
                                <button type="button" id="button-save-changes" title="Save Changes"
                                        class="btn btn-primary ml-2 mt-2 mb-2 button_apply_changes" style="display: none;">
                                    <i class="fa-solid fa-save"></i>
                                    &nbsp;Save Changes
                                </button>
                                <button type="button" id="button-update-from-primary" title="Update from Primary"
                                        class="btn btn-primary ml-2 mt-2 mb-2 button_update_from_primary" style="display: none;">
                                    <i class="fa-solid fa-sync"></i>
                                    &nbsp;Update from Primary
                                </button>
                            </div>
                        </div>
                        <div class="card-body table-responsive" id="card-zone-body" style="display: none;">
                            <table id="tbl_records" class="table table-bordered table-striped table-hover table-sm">
                                <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>TTL</th>
                                    <th>Data</th>
                                    <th>Comment</th>
                                    <th>Edit</th>
                                    <th>Delete</th>
                                    <th>Changelog</th>
                                </tr>
                                </thead>
                                <tbody id="table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block head_styles %}
    <style>
        /* Page Specific Overrides */
        table#tbl_records thead th:nth-child(1),
        table#tbl_records thead th:nth-child(2),
        table#tbl_records thead th:nth-child(3),
        table#tbl_records thead th:nth-child(4) { width: 100px; }
        table#tbl_records tbody td { text-align: center; }
        table#tbl_records tbody td:nth-child(0n+5),
        table#tbl_records tbody td:nth-child(0n+6) { text-align: left; word-break: break-all; }
    </style>
{% endblock %}

{% block extrascripts %}
    <script>
        // superglobals
        window.nEditing = null;
        window.nNew = false;
        window.records_allow_edit = null;
        window.ttl_options = null;

        var csrf_token = "{{ csrf_token() }}";
        var unsavedChanges = false;

        $(document).ready(function() {
            $.getJSON($SCRIPT_ROOT + "{{ domain.name }}" + '/data', function(data) {
                window.records_allow_edit = data.editable_records;
                window.ttl_options = data.ttl_options;

                // Update the domain data
                $('#page-title').text("Zone Records - " + data.domain.name +  '- {{ SITE_NAME }}');
                $('#breadcrumb-active').text("Zone Records - " + data.domain.name);
                $('#button-zone-settings').click(function() {
                    window.location.href = $SCRIPT_ROOT + '/domain/setting/' + data.domain.name + '/manage';
                });
                $('#button-zone-changelog').click(function() {
                    window.location.href = $SCRIPT_ROOT + '/domain/' + data.domain.name + '/changelog';
                });
                $('#domain-name').text(data.domain.name);
                $('#domain-type').text(data.domain.type);
                if (data.domain.type !== 'Slave') {
                    $('#button-add-record').show();
                    $('#button-save-changes').data('domain-name', data.domain.name).data('domain-serial', data.domain.serial).show();
                } else {
                    $('#button-update-from-primary').show();
                }

                $('#spinner-card').hide();
                $('#card-zone').show();
                $('#card-zone-header').show();
                $('#card-zone-body').show();

                var currentUserRole = data.current_user.role;
                var allowUserViewHistory = data.allow_user_view_history;

                $('#table-body').empty(); // remove any existing rows
                $.each(data.records, function(i, record) {
                    var currentUserRole = data.current_user.role;
                    var allowUserViewHistory = data.allow_user_view_history;
                    var row = '<tr class="row_record" id="' + data.domain.name + '">' +
                        '<td>' + record.name + '</td>' +
                        '<td>' + record.type + '</td>' +
                        '<td>' + record.status + '</td>' +
                        '<td>' + record.ttl + '</td>' +
                        '<td>' + record.data + '</td>' +
                        '<td>' + record.comment + '</td>' +
                        '<td>' + (record.is_allowed_edit 
                                ? '<button type="button" class="btn btn-sm btn-warning button_edit"><i class="fa-solid fa-edit"></i></button>' 
                                : '<button type="button" class="btn btn-sm btn-warning"><i class="fa-solid fa-exclamation-circle"></i></button>') + 
                        '</td>' +
                        '<td>' + (record.is_allowed_delete 
                                ? '<button type="button" class="btn btn-sm btn-danger button_delete"><i class="fa-solid fa-trash"></i></button>' 
                                : '<button type="button" class="btn btn-sm btn-warning"><i class="fa-solid fa-exclamation-circle"></i></button>') + 
                        '</td>' +
                        '<td>' + (currentUserRole in ['Administrator', 'Operator'] || allowUserViewHistory 
                                ? '<button type="button" onclick="show_record_changelog(\'' + record.name + '\',\'' + record.type + '\',event)" class="btn btn-primary"><i class="fa-solid fa-history" aria-hidden="true"></i></button>' 
                                : '<button type="button" class="btn btn-sm btn-warning"><i class="fa-solid fa-exclamation-circle"></i></button>') + 
                        '</td>' +
                        '<td>1</td>' +
                    '</tr>';
                    $('#table-body').append(row);
                });

                $('#editable-records').empty();
                $.each(data.editable_records, function(i, recordType) {
                    $('#editable-records').append('<p>' + recordType + '</p>');
                });
                
                var domainType = data.domain.type;
                var records = data.records;
                var lengthMenu;
                var defaultRecordTableSize = {{ SETTING.get('default_record_table_size') }};  // Fetch this from the server
                
                if (['5','15','20'].includes(defaultRecordTableSize)) {
                    lengthMenu = [[5, 15, 20, -1], [5, 15, 20, "All"]];
                } else {
                    lengthMenu = [[5, 15, 20, defaultRecordTableSize, -1], [5, 15, 20, defaultRecordTableSize, "All"]];
                }

                // Determine the targets for the hidden column and orderFixed
                var hiddenColumnTargets, orderFixed;
                if (data.domain.type != 'Slave') {
                    if (currentUserRole in ['Administrator', 'Operator'] || allowUserViewHistory) {
                        hiddenColumnTargets = [9];
                        orderFixed = [[9, 'asc']];
                    } else {
                        hiddenColumnTargets = [8];
                        orderFixed = [[8, 'asc']];
                    }
                } else {
                    hiddenColumnTargets = [5];
                    orderFixed = [[5, 'asc']];
                }
                
                // DataTable Initialization
                $("#tbl_records").DataTable({
                    "paging": true,
                    "lengthChange": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "autoWidth": false,
                    "lengthMenu": lengthMenu,
                    "pageLength": defaultRecordTableSize,
                    "language": {
                        "lengthMenu": " _MENU_ records"
                    },
                    "retrieve": true,
                    "columnDefs": [
                        {
                            type: 'natural',
                            targets: [0, 4]
                        },
                        {
                            targets: [0, 1, 2, 3, 4, 5],
                            render: $.fn.dataTable.render.text()
                        },
                        {
                            // hidden column so that we can add new records on top
                            // regardless of whatever sorting is done. See orderFixed
                            visible: false,
                            targets: hiddenColumnTargets
                        },
                        {
                            targets: [0],
                            className: "text-right",
                            data: {
                                '_': "0",
                                'sort': function (row, _type, _set, _meta) {
                                    const data = row[0] || '';
                                    return data.split('.').reverse().join('.');
                                },
                            },
                        }
                    ],
                    "orderFixed": orderFixed
                });


                // handle add record button
                $(document.body).on("click", ".button_add_record", function (e) {
                    if (nNew || nEditing) {
                        showErrorModal("Previous record not saved. Please save it before adding more record.");
                        return;
                    }
                    // clear search first
                    $("#tbl_records").DataTable().search('').columns().search('').draw();

                    // add new row
                    var default_type = window.records_allow_edit[0];
                    {% if current_user.role.name in ['Administrator', 'Operator'] or allow_user_view_history %}
                        var nRow = jQuery('#tbl_records').dataTable().fnAddData(['', default_type, 'Active', window.ttl_options[0][0], '', '', '', '', '', '0']);
                    {% else %}
                        var nRow = jQuery('#tbl_records').dataTable().fnAddData(['', default_type, 'Active', window.ttl_options[0][0], '', '', '', '', '0']);
                    {% endif %}
                    editRow($("#tbl_records").DataTable(), nRow);
                    document.getElementById("edit-row-focus").focus();
                    nEditing = nRow;
                    nNew = true;
                });
            });

        });

        function show_record_changelog(record_name, record_type, e) {
            e.stopPropagation();
            var domainName = "{{ domain.name }}";
            var url;

            if(record_name === "@") {
                recordChangelogUrl = '/domain/' + domainName + '/changelog/' + domainName + './' + record_type;
            } else {
                recordChangelogUrl = '/domain/' + domainName + '/changelog/' + record_name + "." + domainName + './' + record_type;
            }

            window.location.href = recordChangelogUrl;
        }


        // handle changelog button
        $(document.body).on("click", ".button_changelog", function (e) {
            e.stopPropagation();
            window.location.href = "/domain/" + "{{ domain.name }}" + "/changelog";
        });

        // handle delete button
        $(document.body).on("click", ".button_delete", function (e) {
            e.stopPropagation();
            var modal = $("#modal_delete");
            var table = $("#tbl_records").DataTable();
            var record = $(this).prop('id');
            var nRow = $(this).parents('tr')[0];
            var info = "Are you sure you want to delete " + record + "?";
            modal.find('.modal-body p').text(info);
            modal.modal('show');

            $("#button_delete_confirm").unbind().one('click', function (e) {
                table.row(nRow).remove().draw();
                detectUnsavedChanges(table);
                modal.modal('hide');
            });

            $("#button_delete_cancel").unbind().one('click', function (e) {
                modal.modal('hide');
            });
        });
        // handle edit button and record click
            $(document.body).on("click", ".button_edit{% if quick_edit %}, .row_record{% endif %}", function (e) {
                e.stopPropagation();
                if ($(this).is('tr')) {
                    var nRow = $(this)[0];
                } else {
                    var nRow = $(this).parents('tr')[0];
                }
                var table = $("#tbl_records").DataTable();

                if (nEditing == nRow) {
                    /* click on row already being edited, do nothing */
                } else if (nEditing !== null && nEditing != nRow && nNew == false) {
                    /* Currently editing - but not this row - restore the old before continuing to edit mode */
                    restoreRow(table, nEditing);
                    editRow(table, nRow);
                    nEditing = nRow;
                } else if (nNew == true) {
                    /* adding a new row, delete it and start editing */
                    table.row(nEditing).remove().draw();
                    nNew = false;
                    editRow(table, nRow);
                    nEditing = nRow;
                } else {
                    /* No edit in progress - let's start one */
                    editRow(table, nRow);
                    nEditing = nRow;
                }
            });

        // handle apply changes button
        $(document.body).on("click", "#button-save-changes", function () {
            if (nNew || nEditing) {
                showErrorModal("Previous record not saved. Please save it before applying the changes.");
                return;
            }

            var modal = $("#modal_apply_changes");
            var table = $("#tbl_records").DataTable();
            var domain = $(this).data('domain-name');
            var serial = $(this).data('domain-serial');
            var info = '<p id="info-text">Are you sure you want to apply your changes?</p>';
            var spinner = '<div class="spinner-border text-primary" role="status" id="spinner" style="display:none;"><span class="sr-only">Loading...</span></div>';
            modal.find('.modal-body').html(info + spinner);
            
            // Hide OK button initially
            modal.find("#button_ok").hide();

            // following unbind("click") is to avoid multiple times execution
            modal.find('#button_apply_confirm').unbind("click").click(function () {
                var data = {'serial': serial, 'record': getTableData(table)};

                // Hide info text and show spinner
                $("#info-text").hide();
                $("#spinner").show();
                // Change the modal header title
                modal.find('.modal-title').text('Applying changes');
                // Hide Apply and Close buttons
                modal.find('#button_apply_confirm, #button_close').hide();

                // Make AJAX call
                applyRecordChanges(data, domain, csrf_token).done(function() {
                    // Hide spinner and show success info
                    $("#spinner").hide();
                    modal.find('.modal-title').text('Success');
                    modal.find('.modal-body').html("<p>Applied changes successfully.</p>");
                    // Show OK button
                    modal.find("#button_ok").show();

                    // Bind click event to "OK" button to reload the page
                    modal.find("#button_ok").unbind("click").click(function(e) {
                        e.stopPropagation();  // prevent bootstrap's event listeners from closing the modal
                        modal.find("#button_ok").hide();
                        modal.find('.modal-title').text('Reloading');
                        var info = '<p id="info-text">The page will refresh momentarily...</p>';
                        modal.find('.modal-body').html(info);
                        location.reload(); // Reload the page
                    });
                }).fail(function(jqXHR, status) {
                    console.log(jqXHR);
                    var responseJson = JSON.parse(jqXHR.responseText);
                    modal.find('.modal-title').text('Error');
                    modal.find('.modal-body').html("<p>" + responseJson['msg'] + "</p>");
                    // Show OK button
                    modal.find("#button_ok").show();
                });
            });
            modal.modal('show');
        });

        //handle cancel button
        $(document.body).on("click", ".button_cancel", function (e) {
            e.stopPropagation();
            var oTable = $("#tbl_records").DataTable();
            if (nNew) {
                oTable.row(nEditing).remove().draw();
                nEditing = null;
                nNew = false;
            } else {
                restoreRow(oTable, nEditing);
                nEditing = null;
            }
        });

        //handle save button
        $(document.body).on("click", ".button_save", function (e) {
            e.stopPropagation();
            var table = $("#tbl_records").DataTable();
            saveRow(table, nEditing);
            detectUnsavedChanges(table);
            nEditing = null;
            nNew = false;
        });

        //handle update_from_primary button
        $(document.body).on("click", ".button_update_from_primary", function (e) {
            var domain = $(this).prop('id');
            applyChanges({
                'domain': domain,
                '_csrf_token': '{{ csrf_token() }}'
            }, $SCRIPT_ROOT + '/domain/' + '123' + '/update', true);
        });

        function detectUnsavedChanges(table) {
            // Reset unsavedChanges to false at the start of the function
            unsavedChanges = false;
            var index = 0;
            var origcount = {{ records|length }};
            var count = table.page.info().recordsTotal;
            var changes = {};  // Dictionary to store changes
        
            if (count != origcount) {
                unsavedChanges = true; //a record was either added or deleted.
            } else {
                {% for record in records %}
                var origrecordname = '{{ (record.name,domain.name) | display_record_name }}';
                var origrecordtype = '{{ record.type }}';
                var origrecordstatus = '{{ record.status }}';
                var origrecordttl = '{{ record.ttl }}';
                var origrecorddata = '{{ record.data }}';
                origrecorddata = origrecorddata.replace(/&#34;/g, '\"');
                var origrecordcomment = '{{ record.comment }}';
                if (!table.row(index) || typeof table.row(index) == 'undefined') {
                    unsavedChanges = true; //sanity check otherwise below code throws error if row at that index doesn't exist.
                } else {
                    var editrecordname = table.row(index).data()[0];
                    var editrecordtype = table.row(index).data()[1];
                    var editrecordstatus = table.row(index).data()[2];
                    var editrecordttl = table.row(index).data()[3];
                    var editrecorddata = table.row(index).data()[4];
                    var editrecordcomment = table.row(index).data()[5];
                    if (origrecordname != editrecordname || origrecordtype != editrecordtype || origrecordstatus != editrecordstatus || origrecordttl != editrecordttl ||  origrecorddata != editrecorddata ||  origrecordcomment != editrecordcomment) {
                        unsavedChanges = true;
                    }
                }
                index++;
                {% endfor %}
            }
            unsavedChangesWarning(unsavedChanges);

            // Get the modal and the navigation links
            var modal = document.getElementById('WarnLeave');
            var navLinks = document.querySelectorAll('.nav-link');

            // Listen for clicks on navigation links
            navLinks.forEach(function(link) {
                if (!link.classList.contains('no-prompt')) {
                    link.addEventListener('click', function(event) {
                        if (unsavedChanges) {
                            event.preventDefault();  // Prevent navigation
                            modal.style.display = "block";  // Show the modal
                            // Get the buttons
                            var stayButton = document.getElementById('stay');
                            var leaveButton = document.getElementById('leave');
        
                            // When the user clicks on "Stay", close the modal
                            stayButton.onclick = function() {
                                modal.style.display = "none";
                            }
        
                            // When the user clicks on "Leave", navigate away
                            leaveButton.onclick = function() {
                                unsavedChanges = false;  // No unsaved changes anymore
                                location.href = link.href;  // Navigate to the clicked link
                            }
                        }
                    });
                }
            });
        }

        function unsavedChangesWarning(unsavedChanges) {
            var card = document.getElementById("unsaved-changes-card");
            var cardBody = card.querySelector(".card-body");
        
            if(unsavedChanges){
                var message = 'There are unsaved changes for the zone. Please click Save Changes to save all of your changes.';
                card.style.display = 'block';  // to show the card
                cardBody.innerHTML = message;
                return false;
            } else {
                card.style.display = 'none';  // to hide the card
            }
        }

        {% if SETTING.get('record_helper') %}
            {% include "zone_record_helper.html" %}
        {% endif %}

    </script>

{% endblock %}

{% block modals %}
    <div class="modal fade" id="modal_delete">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Confirmation</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary pull-left" id="button_delete_cancel"
                            data-dismiss="modal">
                        <i class="fa-solid fa-window-close"></i>&nbsp;Close
                    </button>
                    <button type="button" class="btn btn-danger" id="button_delete_confirm">
                        <i class="fa-solid fa-trash"></i>&nbsp;Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal_apply_changes">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Confirmation</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="button_close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body d-flex justify-content-center">
                    <p></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="button_close">
                        <i class="fa-solid fa-window-close"></i>&nbsp;Close
                    </button>
                    <button type="button" class="btn btn-success" id="button_apply_confirm">
                        <i class="fa-solid fa-save"></i>&nbsp;Apply Changes
                    </button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="button_ok" style="display: none;">
                        <i class="fa-solid fa-check-circle"></i>&nbsp;OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal_custom_record">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Custom Record</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fa-solid fa-window-close"></i>&nbsp;Close
                    </button>
                    <button type="button" class="btn btn-success" id="button_save">
                        <i class="fa-solid fa-save"></i>&nbsp;Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" tabindex="-1" id="WarnLeave">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Unsaved Changes</h5>
                </div>
                <div class="modal-body">
                    <p>You have unsaved changes. Are you sure you want to navigate away?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="stay">Stay</button>
                    <button type="button" class="btn btn-secondary" id="leave">Leave</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
